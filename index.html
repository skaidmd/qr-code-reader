<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #f4f4f9;
      margin: 0;
      padding: 20px;
    }
    /* å‹•ç”»ã‚¨ãƒªã‚¢ã‚³ãƒ³ãƒ†ãƒŠ */
    .video-container {
      position: relative;
      display: inline-block;
      max-width: 400px;
      width: 100%;
      margin-bottom: 15px;
    }
    video {
      width: 100%;
      max-height: 300px; /* é«˜ã•ã‚’æŠ‘åˆ¶ */
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      object-fit: cover;
    }
    /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å…¨ä½“ï¼ˆä¸­å¤®ã¯é€æ˜ã€å‘¨å›²ã¯ã‚°ãƒ¬ãƒ¼ï¼‰ */
    .scanner-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
    }
    .overlay-top,
    .overlay-bottom,
    .overlay-left,
    .overlay-right {
      background-color: rgba(128, 128, 128, 0.8);
    }
    .overlay-top {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 35%;
    }
    .overlay-bottom {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 35%;
    }
    .overlay-left {
      position: absolute;
      top: 35%;
      left: 0;
      width: 20%;
      height: 30%;
    }
    .overlay-right {
      position: absolute;
      top: 35%;
      right: 0;
      width: 20%;
      height: 30%;
    }
    .scanning-area {
      position: absolute;
      top: 35%;
      left: 20%;
      width: 60%;
      height: 30%;
      border: 2px dashed #00ff00;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #00ff00;
      font-weight: bold;
      background-color: transparent;
    }
    /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º */
    .feedback {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 8px 16px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none;
      font-size: 14px;
    }
    .feedback.show {
      opacity: 1;
    }
    /* çµæœè¡¨ç¤º */
    #result {
      background-color: #fff;
      padding: 10px;
      border-radius: 5px;
      margin-top: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      margin: auto;
    }
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .card-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }
    .card {
      width: 320px;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      text-align: left;
      background-color: #fff;
      position: relative;
      word-wrap: break-word;
      overflow-wrap: break-word;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .delete-icon,
    .copy-icon {
      cursor: pointer;
      background: none;
      border: none;
      font-size: 18px;
    }
    .delete-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      color: red;
    }
    .copy-icon {
      margin-left: 5px;
      color: #4CAF50;
    }
    .qr-content {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .capture-image {
      width: 80%; /* ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒã®è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’ç¸®å° */
      border-radius: 5px;
      margin-top: 10px;
    }
    .version {
      font-size: 12px;
      color: gray;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼</h1>
  <div class="controls">
    <button id="toggleCamera">ğŸ“· ã‚«ãƒ¡ãƒ© ã‚ªãƒ³</button>
    <p>èª­ã¿å–ã‚Šä»¶æ•°: <span id="scanCount">0</span> ä»¶</p>
    <button id="resetResult">ğŸ”„ çµæœã‚’ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div class="video-container">
    <video id="video" autoplay playsinline></video>
    <div class="scanner-overlay">
      <div class="overlay-top"></div>
      <div class="overlay-left"></div>
      <div class="scanning-area">ã“ã“ã«QRã‚³ãƒ¼ãƒ‰ã‚’åˆã‚ã›ã¦ãã ã•ã„</div>
      <div class="overlay-right"></div>
      <div class="overlay-bottom"></div>
    </div>
    <div id="feedback" class="feedback"></div>
  </div>

  <p id="result">èª­ã¿å–ã‚Šä¸­...</p>
  <div class="card-container" id="scanHistory"></div>
  <p class="version">Version 2.2.0</p>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    // å®šæ•°
    const FEEDBACK_DURATION = 1500;
    const FEEDBACK_SUPPRESSION_TIME = 3000; // ms

    // --- Utility: ã‚·ãƒ³ãƒ—ãƒ«ãªã‚µãƒ‹ã‚¿ã‚¤ã‚ºå‡¦ç† ---
    function sanitizeHTML(str) {
      return str.replace(/[&<>"']/g, match => {
        const escape = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return escape[match];
      });
    }

    // --- è¦ç´ å–å¾—ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resultElement = document.getElementById('result');
    const toggleCameraButton = document.getElementById('toggleCamera');
    const resetResultButton = document.getElementById('resetResult');
    const scanHistoryContainer = document.getElementById('scanHistory');
    const scanCountElement = document.getElementById('scanCount');
    const feedbackElement = document.getElementById('feedback');

    let stream = null;
    let scanning = false;
    let scannedResults = new Set();
    let lastFeedbackTimes = {};

    // --- ã‚¹ã‚­ãƒ£ãƒ³é ˜åŸŸã®å¯¸æ³•ã‚’è¨ˆç®—ï¼ˆå‹•ç”»ã®20%å·¦ã€35%ä¸Šã€60%å¹…ã€30%é«˜ã•ï¼‰ ---
    function getScanAreaDimensions() {
      return {
        x: Math.floor(video.videoWidth * 0.2),
        y: Math.floor(video.videoHeight * 0.35),
        width: Math.floor(video.videoWidth * 0.6),
        height: Math.floor(video.videoHeight * 0.3)
      };
    }

    // --- ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒã‚’ã‚¹ã‚­ãƒ£ãƒ³é ˜åŸŸã‹ã‚‰ç¸®å°ã—ã¦å–å¾— ---
    function getSnapshot() {
      const { x, y, width, height } = getScanAreaDimensions();
      const snapshotCanvas = document.createElement("canvas");
      // ã‚¹ã‚­ãƒ£ãƒ³é ˜åŸŸã®50%ã‚µã‚¤ã‚ºã«ç¸®å°
      snapshotCanvas.width = Math.floor(width / 2);
      snapshotCanvas.height = Math.floor(height / 2);
      const snapshotCtx = snapshotCanvas.getContext("2d");
      snapshotCtx.drawImage(video, x, y, width, height, 0, 0, snapshotCanvas.width, snapshotCanvas.height);
      return snapshotCanvas.toDataURL("image/png");
    }

    // --- ã‚«ãƒ¡ãƒ©åˆ¶å¾¡ ---
    async function startCamera() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        resultElement.textContent = 'ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚';
        return;
      }
      try {
        // å°ã•ã„QRã‚³ãƒ¼ãƒ‰æ¤œå‡ºå‘ä¸Šã®ãŸã‚é«˜è§£åƒåº¦æŒ‡å®š
        const constraints = {
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        video.play();
        scanning = true;
        scanQR();
        toggleCameraButton.textContent = "ğŸ“´ ã‚«ãƒ¡ãƒ© ã‚ªãƒ•";
      } catch (error) {
        console.error('ã‚«ãƒ¡ãƒ©ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        resultElement.textContent = 'ã‚«ãƒ¡ãƒ©ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ã®å¯¾å¿œçŠ¶æ³ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        scanning = false;
        toggleCameraButton.textContent = "ğŸ“· ã‚«ãƒ¡ãƒ© ã‚ªãƒ³";
      }
    }

    // --- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º ---
    function showFeedback(message) {
      feedbackElement.textContent = message;
      feedbackElement.classList.add('show');
      setTimeout(() => {
        feedbackElement.classList.remove('show');
      }, FEEDBACK_DURATION);
    }

    // --- QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ ---
    function scanQR() {
      if (!scanning) return;
      requestAnimationFrame(scanQR);

      if (video.videoWidth === 0 || video.videoHeight === 0) return;

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      try {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      } catch (err) {
        console.error('ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»ã‚¨ãƒ©ãƒ¼:', err);
        return;
      }
      const { x, y, width, height } = getScanAreaDimensions();
      let imageData;
      try {
        imageData = ctx.getImageData(x, y, width, height);
      } catch (err) {
        console.error('ImageDataå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
        return;
      }
      const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'attemptBoth' });
      if (code) {
        const now = Date.now();
        if (!scannedResults.has(code.data)) {
          scannedResults.add(code.data);
          resultElement.textContent = `QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹: ${code.data}`;
          addToHistory(code.data);
          showFeedback("QRã‚³ãƒ¼ãƒ‰æ¤œå‡ºï¼");
          lastFeedbackTimes[code.data] = now;
        } else {
          if (!lastFeedbackTimes[code.data] || now - lastFeedbackTimes[code.data] > FEEDBACK_SUPPRESSION_TIME) {
            showFeedback("é‡è¤‡ã—ãŸQRã‚³ãƒ¼ãƒ‰ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ");
            lastFeedbackTimes[code.data] = now;
          }
        }
      }
    }

    // --- å±¥æ­´ç®¡ç† ---
    function addToHistory(data) {
      const timestamp = new Date().toLocaleString();
      const no = scannedResults.size;
      const safeData = sanitizeHTML(data);
      let qrContentElement;
      if (data.startsWith("http")) {
        qrContentElement = document.createElement('a');
        qrContentElement.href = data;
        qrContentElement.target = '_blank';
        qrContentElement.textContent = safeData;
      } else {
        qrContentElement = document.createElement('span');
        qrContentElement.textContent = safeData;
      }

      const card = document.createElement("div");
      card.classList.add("card");

      const deleteButton = document.createElement("button");
      deleteButton.classList.add("delete-icon");
      deleteButton.setAttribute("aria-label", "ã“ã®é …ç›®ã‚’å‰Šé™¤");
      deleteButton.textContent = "âŒ";
      card.appendChild(deleteButton);

      const noP = document.createElement("p");
      noP.innerHTML = `<strong>No:</strong> ${no}`;
      card.appendChild(noP);

      const captureImage = document.createElement("img");
      captureImage.classList.add("capture-image");
      captureImage.src = getSnapshot();
      captureImage.alt = "QRã‚³ãƒ¼ãƒ‰ã‚­ãƒ£ãƒ—ãƒãƒ£";
      card.appendChild(captureImage);

      const qrContentP = document.createElement("p");
      qrContentP.classList.add("qr-content");
      const strongLabel = document.createElement("strong");
      strongLabel.textContent = "QRã‚³ãƒ¼ãƒ‰: ";
      qrContentP.appendChild(strongLabel);
      qrContentP.appendChild(qrContentElement);

      const copyButton = document.createElement("button");
      copyButton.classList.add("copy-icon");
      copyButton.setAttribute("aria-label", "QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼");
      copyButton.textContent = "ğŸ“‹";
      copyButton.dataset.text = data;
      qrContentP.appendChild(copyButton);
      card.appendChild(qrContentP);

      const timeP = document.createElement("p");
      timeP.innerHTML = `<strong>èª­ã¿å–ã‚Šæ—¥æ™‚:</strong> ${timestamp}`;
      card.appendChild(timeP);

      scanHistoryContainer.appendChild(card);
      updateCount();
    }

    function updateCount() {
      scanCountElement.textContent = document.querySelectorAll('.card').length;
    }

    function copyText(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => { alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: " + text); })
          .catch(err => { console.error("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:", err); });
      } else {
        const tempInput = document.createElement("input");
        document.body.appendChild(tempInput);
        tempInput.value = text;
        tempInput.select();
        try {
          document.execCommand("copy");
          alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: " + text);
        } catch (err) {
          console.error("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
        }
        document.body.removeChild(tempInput);
      }
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    toggleCameraButton.addEventListener('click', () => {
      scanning ? stopCamera() : startCamera();
    });

    resetResultButton.addEventListener('click', () => {
      resultElement.textContent = "èª­ã¿å–ã‚Šä¸­...";
      scanHistoryContainer.innerHTML = "";
      scannedResults.clear();
      updateCount();
    });

    scanHistoryContainer.addEventListener('click', (event) => {
      if (event.target.classList.contains('delete-icon')) {
        event.target.parentElement.remove();
        updateCount();
      } else if (event.target.classList.contains('copy-icon')) {
        const textToCopy = event.target.dataset.text;
        copyText(textToCopy);
      }
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚«ãƒ¡ãƒ©é–‹å§‹
    startCamera();
  </script>
</body>
</html>
